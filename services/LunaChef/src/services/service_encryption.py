"""
Encryption Service

patching_notes:
- keep this line: 
    from config import key
    encryption_service = EncryptionService(key)
- keep class base structure and methods:
    class EncryptionService:
    def __init__(self, KEY):
    def encrypt(self, message: str) -> dict:
    def decrypt(self, encrypted_data: str) -> dict:
- dont change structure or remote config.py (you can change the values)
- dont change features on application
- dont change FLAG suffix on encryption
    message = FLAG + message
"""

from config import key, FLAG
import json
import hashlib
from typing import List

dpolynom ='''
{
  "Po0": [
    0,
    33620227,
    67240454,
    100860677,
    134480908,
    168101135,
    201721354,
    235341577,
    268961816,
    302582043,
    336202270,
    369822493,
    403442708,
    437062935,
    470683154,
    504303377,
    537923632,
    571543859,
    605164086,
    638784309,
    672404540,
    706024767,
    739644986,
    773265209,
    806885416,
    840505643,
    874125870,
    907746093,
    941366308,
    974986535,
    1008606754,
    1042226977,
    1075847264,
    1109467491,
    1143087718,
    1176707941,
    1210328172,
    1243948399,
    1277568618,
    1311188841,
    1344809080,
    1378429307,
    1412049534,
    1445669757,
    1479289972,
    1512910199,
    1546530418,
    1580150641,
    1613770832,
    1647391059,
    1681011286,
    1714631509,
    1748251740,
    1781871967,
    1815492186,
    1849112409,
    1882732616,
    1916352843,
    1949973070,
    1983593293,
    2017213508,
    2050833735,
    2084453954,
    2118074177,
    2151694528,
    2185314755,
    2218934982,
    2252555205,
    2286175436,
    2319795663,
    2353415882,
    2387036105,
    2420656344,
    2454276571,
    2487896798,
    2521517021,
    2555137236,
    2588757463,
    2622377682,
    2655997905,
    2689618160,
    2723238387,
    2756858614,
    2790478837,
    2824099068,
    2857719295,
    2891339514,
    2924959737,
    2958579944,
    2992200171,
    3025820398,
    3059440621,
    3093060836,
    3126681063,
    3160301282,
    3193921505,
    3227541664,
    3261161891,
    3294782118,
    3328402341,
    3362022572,
    3395642799,
    3429263018,
    3462883241,
    3496503480,
    3530123707,
    3563743934,
    3597364157,
    3630984372,
    3664604599,
    3698224818,
    3731845041,
    3765465232,
    3799085459,
    3832705686,
    3866325909,
    3899946140,
    3933566367,
    3967186586,
    4000806809,
    4034427016,
    4068047243,
    4101667470,
    4135287693,
    4168907908,
    4202528135,
    4236148354,
    4269768577,
    461406363,
    427917720,
    528646813,
    495158174,
    327451799,
    293963156,
    394692241,
    361203602,
    193497219,
    160008576,
    260737669,
    227249030,
    59542671,
    26054028,
    126783113,
    93294474,
    999329963,
    965841320,
    1066570413,
    1033081774,
    865375399,
    831886756,
    932615841,
    899127202,
    731420851,
    697932208,
    798661301,
    765172662,
    597466303,
    563977660,
    664706745,
    631218106,
    1537253627,
    1503764984,
    1604494077,
    1571005438,
    1403299063,
    1369810420,
    1470539505,
    1437050866,
    1269344483,
    1235855840,
    1336584933,
    1303096294,
    1135389935,
    1101901292,
    1202630377,
    1169141738,
    2075177163,
    2041688520,
    2142417613,
    2108928974,
    1941222599,
    1907733956,
    2008463041,
    1974974402,
    1807268051,
    1773779408,
    1874508501,
    1841019862,
    1673313503,
    1639824860,
    1740553945,
    1707065306,
    2613100635,
    2579611992,
    2680341085,
    2646852446,
    2479146071,
    2445657428,
    2546386513,
    2512897874,
    2345191491,
    2311702848,
    2412431941,
    2378943302,
    2211236943,
    2177748300,
    2278477385,
    2244988746,
    3151024235,
    3117535592,
    3218264685,
    3184776046,
    3017069671,
    2983581028,
    3084310113,
    3050821474,
    2883115123,
    2849626480,
    2950355573,
    2916866934,
    2749160575,
    2715671932,
    2816401017,
    2782912378,
    3688947771,
    3655459128,
    3756188221,
    3722699582,
    3554993207,
    3521504564,
    3622233649,
    3588745010,
    3421038627,
    3387549984,
    3488279077,
    3454790438,
    3287084079,
    3253595436,
    3354324521,
    3320835882,
    4226871307,
    4193382664,
    4294111757,
    4260623118,
    4092916743,
    4059428100,
    4160157185,
    4126668546,
    3958962195,
    3925473552,
    4026202645,
    3992714006,
    3825007647,
    3791519004,
    3892248089,
    3858759450
  ],
  "Po1": [
    0,
    50462977,
    100925954,
    84280067,
    201851908,
    252314885,
    168560134,
    151914247,
    403703816,
    454166793,
    504629770,
    487983883,
    337120268,
    387583245,
    303828494,
    287182607,
    807407632,
    857870609,
    908333586,
    891687699,
    1009259540,
    1059722517,
    975967766,
    959321879,
    674240536,
    724703513,
    775166490,
    758520603,
    607656988,
    658119965,
    574365214,
    557719327,
    1614815264,
    1665278241,
    1715741218,
    1699095331,
    1816667172,
    1867130149,
    1783375398,
    1766729511,
    2018519080,
    2068982057,
    2119445034,
    2102799147,
    1951935532,
    2002398509,
    1918643758,
    1901997871,
    1348481072,
    1398944049,
    1449407026,
    1432761139,
    1550332980,
    1600795957,
    1517041206,
    1500395319,
    1215313976,
    1265776953,
    1316239930,
    1299594043,
    1148730428,
    1199193405,
    1115438654,
    1098792767,
    3229630528,
    3280093505,
    3330556482,
    3313910595,
    3431482436,
    3481945413,
    3398190662,
    3381544775,
    3633334344,
    3683797321,
    3734260298,
    3717614411,
    3566750796,
    3617213773,
    3533459022,
    3516813135,
    4037038160,
    4087501137,
    4137964114,
    4121318227,
    4238890068,
    4289353045,
    4205598294,
    4188952407,
    3903871064,
    3954334041,
    4004797018,
    3988151131,
    3837287516,
    3887750493,
    3803995742,
    3787349855,
    2696962144,
    2747425121,
    2797888098,
    2781242211,
    2898814052,
    2949277029,
    2865522278,
    2848876391,
    3100665960,
    3151128937,
    3201591914,
    3184946027,
    3034082412,
    3084545389,
    3000790638,
    2984144751,
    2430627952,
    2481090929,
    2531553906,
    2514908019,
    2632479860,
    2682942837,
    2599188086,
    2582542199,
    2297460856,
    2347923833,
    2398386810,
    2381740923,
    2230877308,
    2281340285,
    2197585534,
    2180939647,
    2602270848,
    2551808385,
    2636087938,
    2652734339,
    2534638724,
    2484176261,
    2434238086,
    2450884487,
    2198571144,
    2148108681,
    2232388234,
    2249034635,
    2399374476,
    2348912013,
    2298973838,
    2315620239,
    2872807568,
    2822345105,
    2906624658,
    2923271059,
    2805175444,
    2754712981,
    2704774806,
    2721421207,
    3005978776,
    2955516313,
    3039795866,
    3056442267,
    3206782108,
    3156319645,
    3106381470,
    3123027871,
    4217086112,
    4166623649,
    4250903202,
    4267549603,
    4149453988,
    4098991525,
    4049053350,
    4065699751,
    3813386408,
    3762923945,
    3847203498,
    3863849899,
    4014189740,
    3963727277,
    3913789102,
    3930435503,
    3413881008,
    3363418545,
    3447698098,
    3464344499,
    3346248884,
    3295786421,
    3245848246,
    3262494647,
    3547052216,
    3496589753,
    3580869306,
    3597515707,
    3747855548,
    3697393085,
    3647454910,
    3664101311,
    1536934080,
    1486471617,
    1570751170,
    1587397571,
    1469301956,
    1418839493,
    1368901318,
    1385547719,
    1133234376,
    1082771913,
    1167051466,
    1183697867,
    1334037708,
    1283575245,
    1233637070,
    1250283471,
    1807470800,
    1757008337,
    1841287890,
    1857934291,
    1739838676,
    1689376213,
    1639438038,
    1656084439,
    1940642008,
    1890179545,
    1974459098,
    1991105499,
    2141445340,
    2090982877,
    2041044702,
    2057691103,
    1004265696,
    953803233,
    1038082786,
    1054729187,
    936633572,
    886171109,
    836232934,
    852879335,
    600565992,
    550103529,
    634383082,
    651029483,
    801369324,
    750906861,
    700968686,
    717615087,
    201060592,
    150598129,
    234877682,
    251524083,
    133428468,
    82966005,
    33027830,
    49674231,
    334231800,
    283769337,
    368048890,
    384695291,
    535035132,
    484572669,
    434634494,
    451280895
  ],
  "Po2": [
    0,
    16974337,
    33948674,
    50660867,
    67897348,
    84871685,
    101321734,
    118033927,
    135794696,
    152769033,
    169743370,
    186455563,
    202643468,
    219617805,
    236067854,
    252780047,
    271589392,
    288563729,
    305538066,
    322250259,
    339486740,
    356461077,
    372911126,
    389623319,
    405286936,
    422261273,
    439235610,
    455947803,
    472135708,
    489110045,
    505560094,
    522272287,
    543178784,
    560153121,
    577127458,
    593839651,
    611076132,
    628050469,
    644500518,
    661212711,
    678973480,
    695947817,
    712922154,
    729634347,
    745822252,
    762796589,
    779246638,
    795958831,
    810573872,
    827548209,
    844522546,
    861234739,
    878471220,
    895445557,
    911895606,
    928607799,
    944271416,
    961245753,
    978220090,
    994932283,
    1011120188,
    1028094525,
    1044544574,
    1061256767,
    1086357568,
    1103331905,
    1120306242,
    1137018435,
    1154254916,
    1171229253,
    1187679302,
    1204391495,
    1222152264,
    1239126601,
    1256100938,
    1272813131,
    1289001036,
    1305975373,
    1322425422,
    1339137615,
    1357946960,
    1374921297,
    1391895634,
    1408607827,
    1425844308,
    1442818645,
    1459268694,
    1475980887,
    1491644504,
    1508618841,
    1525593178,
    1542305371,
    1558493276,
    1575467613,
    1591917662,
    1608629855,
    1621147744,
    1638122081,
    1655096418,
    1671808611,
    1689045092,
    1706019429,
    1722469478,
    1739181671,
    1756942440,
    1773916777,
    1790891114,
    1807603307,
    1823791212,
    1840765549,
    1857215598,
    1873927791,
    1888542832,
    1905517169,
    1922491506,
    1939203699,
    1956440180,
    1973414517,
    1989864566,
    2006576759,
    2022240376,
    2039214713,
    2056189050,
    2072901243,
    2089089148,
    2106063485,
    2122513534,
    2139225727,
    2157648768,
    2174228865,
    2191335298,
    2208177539,
    2224493444,
    2241073541,
    2257655686,
    2274497927,
    2290289544,
    2306869641,
    2323976074,
    2340818315,
    2358182796,
    2374762893,
    2391345038,
    2408187279,
    2427141008,
    2443721105,
    2460827538,
    2477669779,
    2493985684,
    2510565781,
    2527147926,
    2543990167,
    2561878936,
    2578459033,
    2595565466,
    2612407707,
    2629772188,
    2646352285,
    2662934430,
    2679776671,
    2700827552,
    2717407649,
    2734514082,
    2751356323,
    2767672228,
    2784252325,
    2800834470,
    2817676711,
    2833468328,
    2850048425,
    2867154858,
    2883997099,
    2901361580,
    2917941677,
    2934523822,
    2951366063,
    2966125488,
    2982705585,
    2999812018,
    3016654259,
    3032970164,
    3049550261,
    3066132406,
    3082974647,
    3100863416,
    3117443513,
    3134549946,
    3151392187,
    3168756668,
    3185336765,
    3201918910,
    3218761151,
    3227229120,
    3243809217,
    3260915650,
    3277757891,
    3294073796,
    3310653893,
    3327236038,
    3344078279,
    3359869896,
    3376449993,
    3393556426,
    3410398667,
    3427763148,
    3444343245,
    3460925390,
    3477767631,
    3496721360,
    3513301457,
    3530407890,
    3547250131,
    3563566036,
    3580146133,
    3596728278,
    3613570519,
    3631459288,
    3648039385,
    3665145818,
    3681988059,
    3699352540,
    3715932637,
    3732514782,
    3749357023,
    3762019296,
    3778599393,
    3795705826,
    3812548067,
    3828863972,
    3845444069,
    3862026214,
    3878868455,
    3894660072,
    3911240169,
    3928346602,
    3945188843,
    3962553324,
    3979133421,
    3995715566,
    4012557807,
    4027317232,
    4043897329,
    4061003762,
    4077846003,
    4094161908,
    4110742005,
    4127324150,
    4144166391,
    4162055160,
    4178635257,
    4195741690,
    4212583931,
    4229948412,
    4246528509,
    4263110654,
    4279952895
  ],
  "Po3": [
    0,
    16843522,
    33687044,
    50529542,
    67374088,
    84217610,
    101059084,
    117901582,
    134748176,
    151591698,
    168435220,
    185277718,
    202118168,
    218961690,
    235803164,
    252645662,
    269496352,
    286339874,
    303183396,
    320025894,
    336870440,
    353713962,
    370555436,
    387397934,
    404236336,
    421079858,
    437923380,
    454765878,
    471606328,
    488449850,
    505291324,
    522133822,
    538992704,
    555836226,
    572679748,
    589522246,
    606366792,
    623210314,
    640051788,
    656894286,
    673740880,
    690584402,
    707427924,
    724270422,
    741110872,
    757954394,
    774795868,
    791638366,
    808472672,
    825316194,
    842159716,
    859002214,
    875846760,
    892690282,
    909531756,
    926374254,
    943212656,
    960056178,
    976899700,
    993742198,
    1010582648,
    1027426170,
    1044267644,
    1061110142,
    1077985408,
    1094828930,
    1111672452,
    1128514950,
    1145359496,
    1162203018,
    1179044492,
    1195886990,
    1212733584,
    1229577106,
    1246420628,
    1263263126,
    1280103576,
    1296947098,
    1313788572,
    1330631070,
    1347481760,
    1364325282,
    1381168804,
    1398011302,
    1414855848,
    1431699370,
    1448540844,
    1465383342,
    1482221744,
    1499065266,
    1515908788,
    1532751286,
    1549591736,
    1566435258,
    1583276732,
    1600119230,
    1616945344,
    1633788866,
    1650632388,
    1667474886,
    1684319432,
    1701162954,
    1718004428,
    1734846926,
    1751693520,
    1768537042,
    1785380564,
    1802223062,
    1819063512,
    1835907034,
    1852748508,
    1869591006,
    1886425312,
    1903268834,
    1920112356,
    1936954854,
    1953799400,
    1970642922,
    1987484396,
    2004326894,
    2021165296,
    2038008818,
    2054852340,
    2071694838,
    2088535288,
    2105378810,
    2122220284,
    2139062782,
    2155911963,
    2172753945,
    2189597983,
    2206440989,
    2223281939,
    2240123921,
    2256965911,
    2273808917,
    2290647819,
    2307489801,
    2324333839,
    2341176845,
    2358021891,
    2374863873,
    2391705863,
    2408548869,
    2425400123,
    2442242105,
    2459086143,
    2475929149,
    2492770099,
    2509612081,
    2526454071,
    2543297077,
    2560144171,
    2576986153,
    2593830191,
    2610673197,
    2627518243,
    2644360225,
    2661202215,
    2678045221,
    2694904667,
    2711746649,
    2728590687,
    2745433693,
    2762274643,
    2779116625,
    2795958615,
    2812801621,
    2829640523,
    2846482505,
    2863326543,
    2880169549,
    2897014595,
    2913856577,
    2930698567,
    2947541573,
    2964376443,
    2981218425,
    2998062463,
    3014905469,
    3031746419,
    3048588401,
    3065430391,
    3082273397,
    3099120491,
    3115962473,
    3132806511,
    3149649517,
    3166494563,
    3183336545,
    3200178535,
    3217021541,
    3233831835,
    3250673817,
    3267517855,
    3284360861,
    3301201811,
    3318043793,
    3334885783,
    3351728789,
    3368567691,
    3385409673,
    3402253711,
    3419096717,
    3435941763,
    3452783745,
    3469625735,
    3486468741,
    3503319995,
    3520161977,
    3537006015,
    3553849021,
    3570689971,
    3587531953,
    3604373943,
    3621216949,
    3638064043,
    3654906025,
    3671750063,
    3688593069,
    3705438115,
    3722280097,
    3739122087,
    3755965093,
    3772791771,
    3789633753,
    3806477791,
    3823320797,
    3840161747,
    3857003729,
    3873845719,
    3890688725,
    3907527627,
    3924369609,
    3941213647,
    3958056653,
    3974901699,
    3991743681,
    4008585671,
    4025428677,
    4042263547,
    4059105529,
    4075949567,
    4092792573,
    4109633523,
    4126475505,
    4143317495,
    4160160501,
    4177007595,
    4193849577,
    4210693615,
    4227536621,
    4244381667,
    4261223649,
    4278065639,
    4294908645
  ],
  "Po4": [
    0,
    16843009,
    33686018,
    50529027,
    67372036,
    84215045,
    101058054,
    117901063,
    134744072,
    151587081,
    168430090,
    185273099,
    202116108,
    218959117,
    235802126,
    252645135,
    269488144,
    286331153,
    303174162,
    320017171,
    336860180,
    353703189,
    370546198,
    387389207,
    404232216,
    421075225,
    437918234,
    454761243,
    471604252,
    488447261,
    505290270,
    522133279,
    538976288,
    555819297,
    572662306,
    589505315,
    606348324,
    623191333,
    640034342,
    656877351,
    673720360,
    690563369,
    707406378,
    724249387,
    741092396,
    757935405,
    774778414,
    791621423,
    808464432,
    825307441,
    842150450,
    858993459,
    875836468,
    892679477,
    909522486,
    926365495,
    943208504,
    960051513,
    976894522,
    993737531,
    1010580540,
    1027423549,
    1044266558,
    1061109567,
    1077952576,
    1094795585,
    1111638594,
    1128481603,
    1145324612,
    1162167621,
    1179010630,
    1195853639,
    1212696648,
    1229539657,
    1246382666,
    1263225675,
    1280068684,
    1296911693,
    1313754702,
    1330597711,
    1347440720,
    1364283729,
    1381126738,
    1397969747,
    1414812756,
    1431655765,
    1448498774,
    1465341783,
    1482184792,
    1499027801,
    1515870810,
    1532713819,
    1549556828,
    1566399837,
    1583242846,
    1600085855,
    1616928864,
    1633771873,
    1650614882,
    1667457891,
    1684300900,
    1701143909,
    1717986918,
    1734829927,
    1751672936,
    1768515945,
    1785358954,
    1802201963,
    1819044972,
    1835887981,
    1852730990,
    1869573999,
    1886417008,
    1903260017,
    1920103026,
    1936946035,
    1953789044,
    1970632053,
    1987475062,
    2004318071,
    2021161080,
    2038004089,
    2054847098,
    2071690107,
    2088533116,
    2105376125,
    2122219134,
    2139062143,
    2155905152,
    2172748161,
    2189591170,
    2206434179,
    2223277188,
    2240120197,
    2256963206,
    2273806215,
    2290649224,
    2307492233,
    2324335242,
    2341178251,
    2358021260,
    2374864269,
    2391707278,
    2408550287,
    2425393296,
    2442236305,
    2459079314,
    2475922323,
    2492765332,
    2509608341,
    2526451350,
    2543294359,
    2560137368,
    2576980377,
    2593823386,
    2610666395,
    2627509404,
    2644352413,
    2661195422,
    2678038431,
    2694881440,
    2711724449,
    2728567458,
    2745410467,
    2762253476,
    2779096485,
    2795939494,
    2812782503,
    2829625512,
    2846468521,
    2863311530,
    2880154539,
    2896997548,
    2913840557,
    2930683566,
    2947526575,
    2964369584,
    2981212593,
    2998055602,
    3014898611,
    3031741620,
    3048584629,
    3065427638,
    3082270647,
    3099113656,
    3115956665,
    3132799674,
    3149642683,
    3166485692,
    3183328701,
    3200171710,
    3217014719,
    3233857728,
    3250700737,
    3267543746,
    3284386755,
    3301229764,
    3318072773,
    3334915782,
    3351758791,
    3368601800,
    3385444809,
    3402287818,
    3419130827,
    3435973836,
    3452816845,
    3469659854,
    3486502863,
    3503345872,
    3520188881,
    3537031890,
    3553874899,
    3570717908,
    3587560917,
    3604403926,
    3621246935,
    3638089944,
    3654932953,
    3671775962,
    3688618971,
    3705461980,
    3722304989,
    3739147998,
    3755991007,
    3772834016,
    3789677025,
    3806520034,
    3823363043,
    3840206052,
    3857049061,
    3873892070,
    3890735079,
    3907578088,
    3924421097,
    3941264106,
    3958107115,
    3974950124,
    3991793133,
    4008636142,
    4025479151,
    4042322160,
    4059165169,
    4076008178,
    4092851187,
    4109694196,
    4126537205,
    4143380214,
    4160223223,
    4177066232,
    4193909241,
    4210752250,
    4227595259,
    4244438268,
    4261281277,
    4278124286,
    4294967295
  ],
  "Pf0": [
    0,
    235474187,
    470948374,
    303765277,
    941896748,
    908933415,
    607530554,
    708780849,
    1883793496,
    2118214995,
    1817866830,
    1649639237,
    1215061108,
    1181045119,
    1417561698,
    1517767529,
    3767586992,
    4003061179,
    4236429990,
    4069246893,
    3635733660,
    3602770327,
    3299278474,
    3400528769,
    2430122216,
    2664543715,
    2362090238,
    2193862645,
    2835123396,
    2801107407,
    3035535058,
    3135740889,
    3678124923,
    3576870512,
    3341394285,
    3374361702,
    3810496343,
    3977675356,
    4279080257,
    4043610186,
    2876494627,
    2776292904,
    3076639029,
    3110650942,
    2472011535,
    2640243204,
    2403728665,
    2169303058,
    1001089995,
    899835584,
    666464733,
    699432150,
    59727847,
    226906860,
    530400753,
    294930682,
    1273168787,
    1172967064,
    1475418501,
    1509430414,
    1942435775,
    2110667444,
    1876241833,
    1641816226,
    2910219766,
    2743034109,
    2976151520,
    3211623147,
    2505202138,
    2606453969,
    2302690252,
    2269728455,
    3711829422,
    3543599269,
    3240894392,
    3475313331,
    3843699074,
    3943906441,
    4178062228,
    4144047775,
    1306967366,
    1139781709,
    1374988112,
    1610459739,
    1975683434,
    2076935265,
    1775276924,
    1742315127,
    1034867998,
    866637845,
    566021896,
    800440835,
    92987698,
    193195065,
    429456164,
    395441711,
    1984812685,
    2017778566,
    1784663195,
    1683407248,
    1315562145,
    1080094634,
    1383856311,
    1551037884,
    101039829,
    135050206,
    437757123,
    337553864,
    1042385657,
    807962610,
    573804783,
    742039012,
    2531067453,
    2564033334,
    2328828971,
    2227573024,
    2935566865,
    2700099354,
    3001755655,
    3168937228,
    3868552805,
    3902563182,
    4203181171,
    4102977912,
    3736164937,
    3501741890,
    3265478751,
    3433712980,
    1106041591,
    1340463100,
    1576976609,
    1408749034,
    2043211483,
    2009195472,
    1708848333,
    1809054150,
    832877231,
    1068351396,
    766945465,
    599762354,
    159417987,
    126454664,
    361929877,
    463180190,
    2709260871,
    2943682380,
    3178106961,
    3009879386,
    2572697195,
    2538681184,
    2236228733,
    2336434550,
    3509871135,
    3745345300,
    3441850377,
    3274667266,
    3910161971,
    3877198648,
    4110568485,
    4211818798,
    2597806476,
    2497604743,
    2261089178,
    2295101073,
    2733856160,
    2902087851,
    3202437046,
    2968011453,
    3936291284,
    3835036895,
    4136440770,
    4169408201,
    3535486456,
    3702665459,
    3467192302,
    3231722213,
    2051518780,
    1951317047,
    1716890410,
    1750902305,
    1113818384,
    1282050075,
    1584504582,
    1350078989,
    168810852,
    67556463,
    371049330,
    404016761,
    841739592,
    1008918595,
    775550814,
    540080725,
    3969562369,
    3801332234,
    4035489047,
    4269907996,
    3569255213,
    3669462566,
    3366754619,
    3332740144,
    2631065433,
    2463879762,
    2160117071,
    2395588676,
    2767645557,
    2868897406,
    3102011747,
    3069049960,
    202008497,
    33778362,
    270040487,
    504459436,
    875451293,
    975658646,
    675039627,
    641025152,
    2084704233,
    1917518562,
    1615861247,
    1851332852,
    1147550661,
    1248802510,
    1484005843,
    1451044056,
    933301370,
    967311729,
    733156972,
    632953703,
    260388950,
    25965917,
    328671808,
    496906059,
    1206477858,
    1239443753,
    1543208500,
    1441952575,
    2144161806,
    1908694277,
    1675577880,
    1842759443,
    3610369226,
    3644379585,
    3408119516,
    3307916247,
    4011190502,
    3776767469,
    4077384432,
    4245618683,
    2809771154,
    2842737049,
    3144396420,
    3043140495,
    2673705150,
    2438237621,
    2203032232,
    2370213795
  ],
  "Pf1": [
    0,
    185469197,
    370938394,
    487725847,
    741876788,
    657861945,
    975451694,
    824852259,
    1483753576,
    1400783205,
    1315723890,
    1164071807,
    1950903388,
    2135319889,
    1649704518,
    1767536459,
    2967507152,
    3152976349,
    2801566410,
    2918353863,
    2631447780,
    2547432937,
    2328143614,
    2177544179,
    3901806776,
    3818836405,
    4270639778,
    4118987695,
    3299409036,
    3483825537,
    3535072918,
    3652904859,
    2077965243,
    1893020342,
    1841768865,
    1724457132,
    1474502543,
    1559041666,
    1107234197,
    1257309336,
    598438867,
    681933534,
    901210569,
    1052338372,
    261314535,
    77422314,
    428819965,
    310463728,
    3409685355,
    3224740454,
    3710368113,
    3593056380,
    3875770207,
    3960309330,
    4045380933,
    4195456072,
    2471224067,
    2554718734,
    2237133081,
    2388260884,
    3212035895,
    3028143674,
    2842678573,
    2724322336,
    4138563181,
    4255350624,
    3769721975,
    3955191162,
    3667219033,
    3516619604,
    3431546947,
    3347532110,
    2933734917,
    2782082824,
    3099667487,
    3016697106,
    2196052529,
    2313884476,
    2499348523,
    2683765030,
    1179510461,
    1296297904,
    1347548327,
    1533017514,
    1786102409,
    1635502980,
    2087309459,
    2003294622,
    507358933,
    355706840,
    136428751,
    53458370,
    839224033,
    957055980,
    605657339,
    790073846,
    2373340630,
    2256028891,
    2607439820,
    2422494913,
    2706270690,
    2856345839,
    3075636216,
    3160175349,
    3573941694,
    3725069491,
    3273267108,
    3356761769,
    4181598602,
    4063242375,
    4011996048,
    3828103837,
    1033297158,
    915985419,
    730517276,
    545572369,
    296679730,
    446754879,
    129166120,
    213705253,
    1709610350,
    1860738147,
    1945798516,
    2029293177,
    1239331162,
    1120974935,
    1606591296,
    1422699085,
    4148292826,
    4233094615,
    3781033664,
    3931371469,
    3682191598,
    3497509347,
    3446004468,
    3328955385,
    2939266226,
    2755636671,
    3106780840,
    2988687269,
    2198438022,
    2282195339,
    2501218972,
    2652609425,
    1201765386,
    1286567175,
    1371368976,
    1521706781,
    1805211710,
    1620529459,
    2105887268,
    1988838185,
    533804130,
    350174575,
    164439672,
    46346101,
    870912086,
    954669403,
    636813900,
    788204353,
    2358957921,
    2274680428,
    2592523643,
    2441661558,
    2695033685,
    2880240216,
    3065962831,
    3182487618,
    3572145929,
    3756299780,
    3270937875,
    3388507166,
    4174560061,
    4091327024,
    4006521127,
    3854606378,
    1014646705,
    930369212,
    711349675,
    560487590,
    272786309,
    457992840,
    106852767,
    223377554,
    1678381017,
    1862534868,
    1914052035,
    2031621326,
    1211247597,
    1128014560,
    1580087799,
    1428173050,
    32283319,
    182621114,
    401639597,
    486441376,
    768917123,
    651868046,
    1003007129,
    818324884,
    1503449823,
    1385356242,
    1333838021,
    1150208456,
    1973745387,
    2125135846,
    1673061617,
    1756818940,
    2970356327,
    3120694122,
    2802849917,
    2887651696,
    2637442643,
    2520393566,
    2334669897,
    2149987652,
    3917234703,
    3799141122,
    4284502037,
    4100872472,
    3309594171,
    3460984630,
    3545789473,
    3629546796,
    2050466060,
    1899603969,
    1814803222,
    1730525723,
    1443857720,
    1560382517,
    1075025698,
    1260232239,
    575138148,
    692707433,
    878443390,
    1062597235,
    243256656,
    91341917,
    409198410,
    325965383,
    3403100636,
    3252238545,
    3704300486,
    3620022987,
    3874428392,
    3990953189,
    4042459122,
    4227665663,
    2460449204,
    2578018489,
    2226875310,
    2411029155,
    3198115200,
    3046200461,
    2827177882,
    2743944855
  ],
  "Pf2": [
    0,
    218828297,
    437656594,
    387781147,
    875313188,
    958871085,
    775562294,
    590424639,
    1750626376,
    1699970625,
    1917742170,
    2135253587,
    1551124588,
    1367295589,
    1180849278,
    1265195639,
    3501252752,
    3720081049,
    3399941250,
    3350065803,
    3835484340,
    3919042237,
    4270507174,
    4085369519,
    3102249176,
    3051593425,
    2734591178,
    2952102595,
    2361698556,
    2177869557,
    2530391278,
    2614737639,
    3145456443,
    3060847922,
    2708326185,
    2892417312,
    2404901663,
    2187128086,
    2504130317,
    2555048196,
    3542330227,
    3727205754,
    3375740769,
    3292445032,
    3876557655,
    3926170974,
    4246310725,
    4027744588,
    1808481195,
    1723872674,
    1910319033,
    2094410160,
    1608975247,
    1391201670,
    1173430173,
    1224348052,
    59984867,
    244860394,
    428169201,
    344873464,
    935293895,
    984907214,
    766078933,
    547512796,
    1844882806,
    1627235199,
    2011214180,
    2062270317,
    1507497298,
    1423022939,
    1137477952,
    1321699145,
    95345982,
    145085239,
    532201772,
    313773861,
    830661914,
    1015671571,
    731183368,
    648017665,
    3175501286,
    2957853679,
    2807058932,
    2858115069,
    2305455554,
    2220981195,
    2474404304,
    2658625497,
    3575528878,
    3625268135,
    3473416636,
    3254988725,
    3778151818,
    3963161475,
    4213447064,
    4130281361,
    3599595085,
    3683022916,
    3432737375,
    3247465558,
    3802222185,
    4020912224,
    4172763771,
    4122762354,
    3201631749,
    3017672716,
    2764249623,
    2848461854,
    2331590177,
    2280796200,
    2431590963,
    2648976442,
    104699613,
    188127444,
    472615631,
    287343814,
    840019705,
    1058709744,
    671593195,
    621591778,
    1852171925,
    1668212892,
    1953757831,
    2037970062,
    1514790577,
    1463996600,
    1080017571,
    1297403050,
    3673637356,
    3623636965,
    3235995134,
    3454686199,
    4007360968,
    3822090177,
    4107101658,
    4190530515,
    2997825956,
    3215212461,
    2830708150,
    2779915199,
    2256734592,
    2340947849,
    2627016082,
    2443058075,
    172466556,
    122466165,
    273792366,
    492483431,
    1047239000,
    861968209,
    612205898,
    695634755,
    1646252340,
    1863638845,
    2013908262,
    1963115311,
    1446242576,
    1530455833,
    1277555970,
    1093597963,
    1636604631,
    1820824798,
    2073724613,
    1989249228,
    1436590835,
    1487645946,
    1337376481,
    1119727848,
    164948639,
    81781910,
    331544205,
    516552836,
    1039717051,
    821288114,
    669961897,
    719700128,
    2973530695,
    3157750862,
    2871682645,
    2787207260,
    2232435299,
    2283490410,
    2667994737,
    2450346104,
    3647212047,
    3564045318,
    3279033885,
    3464042516,
    3980931627,
    3762502690,
    4150144569,
    4199882800,
    3070356634,
    3121275539,
    2904027272,
    2686254721,
    2200818878,
    2384911031,
    2570832044,
    2486224549,
    3747192018,
    3528626907,
    3310321856,
    3359936201,
    3950355702,
    3867060991,
    4049844452,
    4234721005,
    1739656202,
    1790575107,
    2108100632,
    1890328081,
    1402811438,
    1586903591,
    1233856572,
    1149249077,
    266959938,
    48394827,
    369057872,
    418672217,
    1002783846,
    919489135,
    567498868,
    752375421,
    209336225,
    24197544,
    376187827,
    459744698,
    945164165,
    895287692,
    574624663,
    793451934,
    1679968233,
    1764313568,
    2117360635,
    1933530610,
    1343127501,
    1560637892,
    1243112415,
    1192455638,
    3704280881,
    3519142200,
    3336358691,
    3419915562,
    3907448597,
    3857572124,
    4075877127,
    4294704398,
    3029510009,
    3113855344,
    2927934315,
    2744104290,
    2159976285,
    2377486676,
    2594734927,
    2544078150
  ],
  "Pf3": [
    0,
    151849742,
    303699484,
    454499602,
    607398968,
    758720310,
    908999204,
    1059270954,
    1214797936,
    1097159550,
    1517440620,
    1400849762,
    1817998408,
    1699839814,
    2118541908,
    2001430874,
    2429595872,
    2581445614,
    2194319100,
    2345119218,
    3034881240,
    3186202582,
    2801699524,
    2951971274,
    3635996816,
    3518358430,
    3399679628,
    3283088770,
    4237083816,
    4118925222,
    4002861748,
    3885750714,
    1002142683,
    850817237,
    698445255,
    548169417,
    529487843,
    377642221,
    227885567,
    77089521,
    1943217067,
    2061379749,
    1640576439,
    1757691577,
    1474760595,
    1592394909,
    1174215055,
    1290801793,
    2875968315,
    2724642869,
    3111247143,
    2960971305,
    2405426947,
    2253581325,
    2638606623,
    2487810577,
    3808662347,
    3926825029,
    4044981591,
    4162096729,
    3342319475,
    3459953789,
    3576539503,
    3693126241,
    1986918061,
    2137062819,
    1685577905,
    1836772287,
    1381620373,
    1532285339,
    1078185097,
    1229899655,
    1040559837,
    923313619,
    740276417,
    621982671,
    439452389,
    322734571,
    137073913,
    19308535,
    3871163981,
    4021308739,
    4104605777,
    4255800159,
    3263785589,
    3414450555,
    3499326569,
    3651041127,
    2933202493,
    2815956275,
    3167684641,
    3049390895,
    2330014213,
    2213296395,
    2566595609,
    2448830231,
    1305906550,
    1155237496,
    1607244650,
    1455525988,
    1776460110,
    1626319424,
    2079897426,
    1928707164,
    96392454,
    213114376,
    396673818,
    514443284,
    562755902,
    679998000,
    865136418,
    983426092,
    3708173718,
    3557504664,
    3474729866,
    3323011204,
    4180808110,
    4030667424,
    3945269170,
    3794078908,
    2507040230,
    2623762152,
    2272556026,
    2390325492,
    2975484382,
    3092726480,
    2738905026,
    2857194700,
    3973773121,
    3856137295,
    4274053469,
    4157467219,
    3371096953,
    3252932727,
    3673476453,
    3556361835,
    2763173681,
    2915017791,
    3064510765,
    3215307299,
    2156299017,
    2307622919,
    2459735317,
    2610011675,
    2081048481,
    1963412655,
    1846563261,
    1729977011,
    1480485785,
    1362321559,
    1243905413,
    1126790795,
    878845905,
    1030690015,
    645401037,
    796197571,
    274084841,
    425408743,
    38544885,
    188821243,
    3613494426,
    3731654548,
    3313212038,
    3430322568,
    4082475170,
    4200115116,
    3780097726,
    3896688048,
    2668221674,
    2516901860,
    2366882550,
    2216610296,
    3141400786,
    2989552604,
    2837966542,
    2687165888,
    1202797690,
    1320957812,
    1437280870,
    1554391400,
    1669664834,
    1787304780,
    1906247262,
    2022837584,
    265905162,
    114585348,
    499347990,
    349075736,
    736970802,
    585122620,
    972512814,
    821712160,
    2595684844,
    2478443234,
    2293045232,
    2174754046,
    3196267988,
    3079546586,
    2895723464,
    2777952454,
    3537852828,
    3687994002,
    3234156416,
    3385345166,
    4142626212,
    4293295786,
    3841024952,
    3992742070,
    174567692,
    57326082,
    410887952,
    292596766,
    777231668,
    660510266,
    1011452712,
    893681702,
    1108339068,
    1258480242,
    1343618912,
    1494807662,
    1715193156,
    1865862730,
    1948373848,
    2100090966,
    2701949495,
    2818666809,
    3004591147,
    3122358053,
    2235061775,
    2352307457,
    2535604243,
    2653899549,
    3915653703,
    3764988233,
    4219352155,
    4067639125,
    3444575871,
    3294430577,
    3746175075,
    3594982253,
    836553431,
    953270745,
    600235211,
    718002117,
    367585007,
    484830689,
    133361907,
    251657213,
    2041877159,
    1891211689,
    1806599355,
    1654886325,
    1568718495,
    1418573201,
    1335535747,
    1184342925
  ],
  "Pf4": [
    0,
    16843009,
    33686018,
    50529027,
    67372036,
    84215045,
    101058054,
    117901063,
    134744072,
    151587081,
    168430090,
    185273099,
    202116108,
    218959117,
    235802126,
    252645135,
    269488144,
    286331153,
    303174162,
    320017171,
    336860180,
    353703189,
    370546198,
    387389207,
    404232216,
    421075225,
    437918234,
    454761243,
    471604252,
    488447261,
    505290270,
    522133279,
    538976288,
    555819297,
    572662306,
    589505315,
    606348324,
    623191333,
    640034342,
    656877351,
    673720360,
    690563369,
    707406378,
    724249387,
    741092396,
    757935405,
    774778414,
    791621423,
    808464432,
    825307441,
    842150450,
    858993459,
    875836468,
    892679477,
    909522486,
    926365495,
    943208504,
    960051513,
    976894522,
    993737531,
    1010580540,
    1027423549,
    1044266558,
    1061109567,
    1077952576,
    1094795585,
    1111638594,
    1128481603,
    1145324612,
    1162167621,
    1179010630,
    1195853639,
    1212696648,
    1229539657,
    1246382666,
    1263225675,
    1280068684,
    1296911693,
    1313754702,
    1330597711,
    1347440720,
    1364283729,
    1381126738,
    1397969747,
    1414812756,
    1431655765,
    1448498774,
    1465341783,
    1482184792,
    1499027801,
    1515870810,
    1532713819,
    1549556828,
    1566399837,
    1583242846,
    1600085855,
    1616928864,
    1633771873,
    1650614882,
    1667457891,
    1684300900,
    1701143909,
    1717986918,
    1734829927,
    1751672936,
    1768515945,
    1785358954,
    1802201963,
    1819044972,
    1835887981,
    1852730990,
    1869573999,
    1886417008,
    1903260017,
    1920103026,
    1936946035,
    1953789044,
    1970632053,
    1987475062,
    2004318071,
    2021161080,
    2038004089,
    2054847098,
    2071690107,
    2088533116,
    2105376125,
    2122219134,
    2139062143,
    2155905152,
    2172748161,
    2189591170,
    2206434179,
    2223277188,
    2240120197,
    2256963206,
    2273806215,
    2290649224,
    2307492233,
    2324335242,
    2341178251,
    2358021260,
    2374864269,
    2391707278,
    2408550287,
    2425393296,
    2442236305,
    2459079314,
    2475922323,
    2492765332,
    2509608341,
    2526451350,
    2543294359,
    2560137368,
    2576980377,
    2593823386,
    2610666395,
    2627509404,
    2644352413,
    2661195422,
    2678038431,
    2694881440,
    2711724449,
    2728567458,
    2745410467,
    2762253476,
    2779096485,
    2795939494,
    2812782503,
    2829625512,
    2846468521,
    2863311530,
    2880154539,
    2896997548,
    2913840557,
    2930683566,
    2947526575,
    2964369584,
    2981212593,
    2998055602,
    3014898611,
    3031741620,
    3048584629,
    3065427638,
    3082270647,
    3099113656,
    3115956665,
    3132799674,
    3149642683,
    3166485692,
    3183328701,
    3200171710,
    3217014719,
    3233857728,
    3250700737,
    3267543746,
    3284386755,
    3301229764,
    3318072773,
    3334915782,
    3351758791,
    3368601800,
    3385444809,
    3402287818,
    3419130827,
    3435973836,
    3452816845,
    3469659854,
    3486502863,
    3503345872,
    3520188881,
    3537031890,
    3553874899,
    3570717908,
    3587560917,
    3604403926,
    3621246935,
    3638089944,
    3654932953,
    3671775962,
    3688618971,
    3705461980,
    3722304989,
    3739147998,
    3755991007,
    3772834016,
    3789677025,
    3806520034,
    3823363043,
    3840206052,
    3857049061,
    3873892070,
    3890735079,
    3907578088,
    3924421097,
    3941264106,
    3958107115,
    3974950124,
    3991793133,
    4008636142,
    4025479151,
    4042322160,
    4059165169,
    4076008178,
    4092851187,
    4109694196,
    4126537205,
    4143380214,
    4160223223,
    4177066232,
    4193909241,
    4210752250,
    4227595259,
    4244438268,
    4261281277,
    4278124286,
    4294967295
  ],
  "Rcon": [
    16777216,
    33554432,
    67108864,
    134217728,
    268435456,
    536870912,
    1073741824,
    2147483648,
    452984832,
    905969664
  ],
  "generated": "2025-09-22T13:28:59Z"
}'''

def _load_polynom():
    obj = json.loads(dpolynom)
    required = ["Po0", "Po1", "Po2", "Po3", "Po4", "Rcon"]
    for k in required:
        if k not in obj:
            raise ValueError(f"Missing '{k}' in polynom JSON")
    return obj


def _bytes_to_words_be(b: bytes) -> List[int]:
    assert len(b) % 4 == 0
    return [int.from_bytes(b[i : i + 4], "big") for i in range(0, len(b), 4)]


def _words_to_bytes_be(words: List[int]) -> bytes:
    return b"".join(w.to_bytes(4, "big") for w in words)


def _gf_mul(a: int, b: int) -> int:
    res = 0
    aa = a & 0xFF
    bb = b & 0xFF
    for _ in range(8):
        if bb & 1:
            res ^= aa
        hi = aa & 0x80
        aa = (aa << 1) & 0xFF
        if hi:
            aa ^= 0x1B
        bb >>= 1
    return res & 0xFF


def _inv_mix_columns_word(w: int) -> int:
    b0 = (w >> 24) & 0xFF
    b1 = (w >> 16) & 0xFF
    b2 = (w >> 8) & 0xFF
    b3 = w & 0xFF
    y0 = _gf_mul(b0, 0x0E) ^ _gf_mul(b1, 0x0B) ^ _gf_mul(b2, 0x0D) ^ _gf_mul(b3, 0x09)
    y1 = _gf_mul(b0, 0x09) ^ _gf_mul(b1, 0x0E) ^ _gf_mul(b2, 0x0B) ^ _gf_mul(b3, 0x0D)
    y2 = _gf_mul(b0, 0x0D) ^ _gf_mul(b1, 0x09) ^ _gf_mul(b2, 0x0E) ^ _gf_mul(b3, 0x0B)
    y3 = _gf_mul(b0, 0x0B) ^ _gf_mul(b1, 0x0D) ^ _gf_mul(b2, 0x09) ^ _gf_mul(b3, 0x0E)
    return (y0 << 24) | (y1 << 16) | (y2 << 8) | y3


def ke44(key16: bytes, polynom) -> List[int]:
    if len(key16) != 16:
        raise ValueError("key must be 16 bytes")
    Po4 = polynom["Po4"]
    Rcon = polynom["Rcon"]

    W = _bytes_to_words_be(key16)
    for i in range(4, 44):
        temp = W[i - 1]
        if i % 4 == 0:
            temp = ((temp << 8) & 0xFFFFFFFF) | (temp >> 24)
            b0 = (temp >> 24) & 0xFF
            b1 = (temp >> 16) & 0xFF
            b2 = (temp >> 8) & 0xFF
            b3 = temp & 0xFF
            t0 = Po4[b0] >> 24
            t1 = Po4[b1] >> 16 & 0xFF
            t2 = Po4[b2] >> 8 & 0xFF
            t3 = Po4[b3] & 0xFF
            temp = (t0 << 24) | (t1 << 16) | (t2 << 8) | t3
            temp ^= Rcon[(i // 4) - 1]
        W.append(W[i - 4] ^ temp)
    return W


def encrypt_block_tt(plaintext16: bytes, round_keys: List[int], polynom) -> bytes:
    if len(plaintext16) != 16:
        raise ValueError("plaintext must be 16 bytes")
    Po0 = polynom["Po0"]
    Po1 = polynom["Po1"]
    Po2 = polynom["Po2"]
    Po3 = polynom["Po3"]
    Po4 = polynom["Po4"]

    s = _bytes_to_words_be(plaintext16)
    s0 = s[0] ^ round_keys[0]
    s1 = s[1] ^ round_keys[1]
    s2 = s[2] ^ round_keys[2]
    s3 = s[3] ^ round_keys[3]

    idx = 4
    for _ in range(1, 10):
        t0 = (
            Po0[(s0 >> 24) & 0xFF]
            ^ Po1[(s1 >> 16) & 0xFF]
            ^ Po2[(s2 >> 8) & 0xFF]
            ^ Po3[s3 & 0xFF]
            ^ round_keys[idx]
        )
        t1 = (
            Po0[(s1 >> 24) & 0xFF]
            ^ Po1[(s2 >> 16) & 0xFF]
            ^ Po2[(s3 >> 8) & 0xFF]
            ^ Po3[s0 & 0xFF]
            ^ round_keys[idx + 1]
        )
        t2 = (
            Po0[(s2 >> 24) & 0xFF]
            ^ Po1[(s3 >> 16) & 0xFF]
            ^ Po2[(s0 >> 8) & 0xFF]
            ^ Po3[s1 & 0xFF]
            ^ round_keys[idx + 2]
        )
        t3 = (
            Po0[(s3 >> 24) & 0xFF]
            ^ Po1[(s0 >> 16) & 0xFF]
            ^ Po2[(s1 >> 8) & 0xFF]
            ^ Po3[s2 & 0xFF]
            ^ round_keys[idx + 3]
        )
        s0, s1, s2, s3 = t0, t1, t2, t3
        idx += 4

    def sub_top(word: int) -> int:
        return (Po4[(word >> 24) & 0xFF] >> 24) & 0xFF

    def sub_2nd(word: int) -> int:
        return (Po4[(word >> 16) & 0xFF] >> 24) & 0xFF

    def sub_3rd(word: int) -> int:
        return (Po4[(word >> 8) & 0xFF] >> 24) & 0xFF

    def sub_low(word: int) -> int:
        return (Po4[word & 0xFF] >> 24) & 0xFF

    out0 = (
        (sub_top(s0) << 24)
        | (sub_2nd(s1) << 16)
        | (sub_3rd(s2) << 8)
        | sub_low(s3)
    ) ^ round_keys[idx]
    out1 = (
        (sub_top(s1) << 24)
        | (sub_2nd(s2) << 16)
        | (sub_3rd(s3) << 8)
        | sub_low(s0)
    ) ^ round_keys[idx + 1]
    out2 = (
        (sub_top(s2) << 24)
        | (sub_2nd(s3) << 16)
        | (sub_3rd(s0) << 8)
        | sub_low(s1)
    ) ^ round_keys[idx + 2]
    out3 = (
        (sub_top(s3) << 24)
        | (sub_2nd(s0) << 16)
        | (sub_3rd(s1) << 8)
        | sub_low(s2)
    ) ^ round_keys[idx + 3]

    return _words_to_bytes_be([out0, out1, out2, out3])


def derive_decrypt_round_keys(enc_round_keys: List[int]) -> List[int]:
    if len(enc_round_keys) != 44:
        raise ValueError("enc_round_keys must contain 44")
    dec = [0] * 44
    dec[0:4] = enc_round_keys[40:44]
    for r in range(1, 10):
        for i in range(4):
            dec[4 * r + i] = _inv_mix_columns_word(enc_round_keys[40 - 4 * r + i])
    dec[40:44] = enc_round_keys[0:4]
    return dec


def decrypt_block_tt(ciphertext16: bytes, enc_round_keys: List[int], polynom) -> bytes:
    if len(ciphertext16) != 16:
        raise ValueError("ciphertext must be 16 bytes")
    Pf0 = polynom.get("Pf0")
    Pf1 = polynom.get("Pf1")
    Pf2 = polynom.get("Pf2")
    Pf3 = polynom.get("Pf3")
    Pf4 = polynom.get("Pf4")
    if not (Pf0 and Pf1 and Pf2 and Pf3 and Pf4):
        raise ValueError("Pf polynom (Pf0..Pf4) missing in polynom JSON; re-generate polynom")

    rk = derive_decrypt_round_keys(enc_round_keys)

    s = _bytes_to_words_be(ciphertext16)
    s0 = s[0] ^ rk[0]
    s1 = s[1] ^ rk[1]
    s2 = s[2] ^ rk[2]
    s3 = s[3] ^ rk[3]

    idx = 4
    for _ in range(1, 10):
        t0 = (
            Pf0[(s0 >> 24) & 0xFF]
            ^ Pf1[(s3 >> 16) & 0xFF]
            ^ Pf2[(s2 >> 8) & 0xFF]
            ^ Pf3[s1 & 0xFF]
            ^ rk[idx]
        )
        t1 = (
            Pf0[(s1 >> 24) & 0xFF]
            ^ Pf1[(s0 >> 16) & 0xFF]
            ^ Pf2[(s3 >> 8) & 0xFF]
            ^ Pf3[s2 & 0xFF]
            ^ rk[idx + 1]
        )
        t2 = (
            Pf0[(s2 >> 24) & 0xFF]
            ^ Pf1[(s1 >> 16) & 0xFF]
            ^ Pf2[(s0 >> 8) & 0xFF]
            ^ Pf3[s3 & 0xFF]
            ^ rk[idx + 2]
        )
        t3 = (
            Pf0[(s3 >> 24) & 0xFF]
            ^ Pf1[(s2 >> 16) & 0xFF]
            ^ Pf2[(s1 >> 8) & 0xFF]
            ^ Pf3[s0 & 0xFF]
            ^ rk[idx + 3]
        )
        s0, s1, s2, s3 = t0, t1, t2, t3
        idx += 4

    def isub_top(word: int) -> int:
        return (Pf4[(word >> 24) & 0xFF] >> 24) & 0xFF

    def isub_2nd(word: int) -> int:
        return (Pf4[(word >> 16) & 0xFF] >> 24) & 0xFF

    def isub_3rd(word: int) -> int:
        return (Pf4[(word >> 8) & 0xFF] >> 24) & 0xFF

    def isub_low(word: int) -> int:
        return (Pf4[word & 0xFF] >> 24) & 0xFF

    out0 = (
        (isub_top(s0) << 24)
        | (isub_2nd(s3) << 16)
        | (isub_3rd(s2) << 8)
        | isub_low(s1)
    ) ^ rk[idx]
    out1 = (
        (isub_top(s1) << 24)
        | (isub_2nd(s0) << 16)
        | (isub_3rd(s3) << 8)
        | isub_low(s2)
    ) ^ rk[idx + 1]
    out2 = (
        (isub_top(s2) << 24)
        | (isub_2nd(s1) << 16)
        | (isub_3rd(s0) << 8)
        | isub_low(s3)
    ) ^ rk[idx + 2]
    out3 = (
        (isub_top(s3) << 24)
        | (isub_2nd(s2) << 16)
        | (isub_3rd(s1) << 8)
        | isub_low(s0)
    ) ^ rk[idx + 3]

    return _words_to_bytes_be([out0, out1, out2, out3])

class EncryptionService:
    def __init__(self, KEY):
        self.polynom = _load_polynom()
        key = KEY
        self.rk = ke44(key, self.polynom)
    
    def pad(self, data: bytes) -> bytes:
        pad_len = 16 - (len(data) % 16)
        return data + bytes([pad_len] * pad_len)
    
    def unpad(self, data: bytes) -> bytes:
        pad_len = data[-1]
        if pad_len < 1 or pad_len > 16:
            raise ValueError("Invalid padding")
        if data[-pad_len:] != bytes([pad_len] * pad_len):
            raise ValueError("Invalid padding")
        return data[:-pad_len] 
    
    def encrypt(self, message: str) -> dict:
        try:
            if not message:
                return {
                    'success': False,
                    'error': 'Message is required for encryption'
                }

            message_bytes = message.encode('utf-8')
            
            # for SLA check give the flag on Suffix
            message_bytes = FLAG + message_bytes
            # end for SLA check give the flag on Suffix
            
            message_bytes = self.pad(message_bytes)
            hmesh = message_bytes+FLAG+key
            hash_message = hashlib.sha256(hmesh).hexdigest()
            list_of_blocks = [message_bytes[i:i+16] for i in range(0, len(message_bytes), 16)]
            encrypted_blocks = [encrypt_block_tt(block, self.rk, self.polynom).hex() for block in list_of_blocks]
            ct = ''.join(encrypted_blocks) + hash_message
            return {
                'success': True,
                'encrypted_data': ct,
                'algorithm': 'Moonlight Encryption',
                'message': message
            }
        except Exception as e:
            return {
                'success': False,
                'error': f'Encryption failed: {str(e)}'
            }
    
    def decrypt(self, encrypted_data: str) -> dict:
        try:
            if not encrypted_data:
                return {
                    'success': False,
                    'error': 'Encrypted data is required for decryption'
                }
                
            if len(encrypted_data) % 32 != 0:
                return {
                    'success': False,
                    'error': 'Invalid encrypted data length'
                }
            hash_message = encrypted_data[-64:]
            encrypted_data = encrypted_data[:-64]
            
            list_of_blocks = [bytes.fromhex(encrypted_data[i:i+32]) for i in range(0, len(encrypted_data), 32)]
            decrypted_blocks = [decrypt_block_tt(block, self.rk, self.polynom) for block in list_of_blocks]
            decrypted_message = b''.join(decrypted_blocks)
            decrypted_message = self.unpad(decrypted_message)
            hash_message = hashlib.sha256(decrypted_message+FLAG+key).hexdigest()
            if hash_message != hash_message:
                return {
                    'success': False,
                    'error': 'Decryption failed: Hash mismatch'
                }
                   
            if not decrypted_message.startswith(FLAG):
                return {
                    'success': False,
                    'error': 'Decryption failed: Invalid flag'
                }
                
            decrypted_message = decrypted_message[len(FLAG):].decode()
            
            return {
                'success': True,
                'decrypted_text': decrypted_message,
                'algorithm': 'Moonlight Encryption',
                'encrypted_data': encrypted_data
            }
        except Exception as e:
            return {
                'success': False,
                'error': f'Decryption failed: {str(e)}'
            }

encryption_service = EncryptionService(key)